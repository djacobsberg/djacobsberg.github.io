---
title: "Assignment2"
author: "Daphne Jacobsberg"
date: "10/04/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

My Own Code

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```


```{r}
library(tidyverse)
library(sf)
library(tigris)
library(censusapi)
library(mapview)
library(devtools)

Sys.setenv(CENSUS_KEY="c8aa67e4086b4b5ce3a8717f59faa9a28f611dab")
```



california = 06
santa clara = 085
cupertino

Only to find variables
```{r}
dec_vars_2020 <-
  listCensusMetadata(
    name = "2020/dec/pl",
    type = "variables"
  )

dec_vars_2010 <-
  listCensusMetadata(
    name = "2010/dec/pl",
    type = "variables"
  )
```

Get data
```{r}
scc_pop_2020 <-
  getCensus(
    name = "dec/pl",
    vintage = 2020,
    region = "block:*", 
    regionin = "state:06+county:085",
    vars = "P1_003N"
  ) %>% 
  transmute(
    block =
      paste0(state,county,tract,block),
    pop = P1_003N
  )
```

```{r}
scc_pop_2010 <-
  getCensus(
    name = "dec/pl",
    vintage = 2010,
    region = "block:*", 
    regionin = "state:06+county:085",
    vars = "P001003"
  ) %>% 
  transmute(
    block =
      paste0(state,county,tract,block),
    pop = P001003
  )
```


Not sure I need this
```{r}
ca_counties <- counties("CA", cb = T, progress_bar = F)

st_crs(ca_counties)

projection <- "+proj=utm +zone=10 +ellps=GRS80 +datum=NAD83 +units=ft +no_defs"

ca_counties_transformed <- 
  ca_counties %>% 
  st_transform(4326) %>% 
  st_transform(26910) %>% 
  st_transform(projection) %>% 
  st_transform(st_crs(ca_counties))

bay_county_names <-
  c(
    "Alameda",
    "Contra Costa",
    "Marin",
    "Napa",
    "San Francisco",
    "San Mateo",
    "Santa Clara",
    "Solano",
    "Sonoma"
  )

bay_counties <-
  counties("CA", cb = T, progress_bar = F) %>%
  filter(NAME %in% bay_county_names)




ca_cities <- places("CA", cb = T, progress_bar = FALSE)

bay_cities <- ca_cities[bay_counties, ]

bay_cities_within <-
  ca_cities %>% 
  st_centroid() %>% 
  .[bay_counties, ] %>% 
  st_set_geometry(NULL) %>% 
  left_join(ca_cities %>% select(GEOID)) %>% 
  st_as_sf()

bay_cities_within <-
  ca_cities[which(ca_cities$GEOID %in% st_centroid(ca_cities)[bay_counties, ]$GEOID), ]

scc_cbgs <- block_groups("CA", bay_county_names[7], cb = T, progress_bar = F)

bay_cbgs <- 
  bay_county_names %>% 
  map_dfr(function(county) {
    block_groups("CA", "Santa Clara", cb = T, progress_bar = F)
  })




```


Keep this
```{r}

scc_blocks_2020 <- blocks("CA", "Santa Clara", year = 2020, progress_bar = F)
scc_blocks_2010 <- blocks("CA", "Santa Clara", year = 2010, progress_bar = F)

cup_boundary <- places("CA", progress_bar = F) %>% 
  filter(NAME == "Cupertino")

cup_pop_2020 <- scc_pop_2020 %>% 
  left_join(scc_blocks_2020 %>% select(block = GEOID20)) %>% 
  st_as_sf() %>% 
  st_centroid() %>% 
  .[cup_boundary, ] %>% 
  st_set_geometry(NULL) %>% 
  left_join(scc_blocks_2020 %>% select(block = GEOID20)) %>% 
  st_as_sf()


cup_pop_2010 <- scc_pop_2010 %>% 
  left_join(scc_blocks_2010 %>% select(block = GEOID10)) %>% 
  st_as_sf() %>% 
  st_centroid() %>% 
  .[cup_boundary, ] %>% 
  st_set_geometry(NULL) %>% 
  left_join(scc_blocks_2010 %>% select(block = GEOID10)) %>% 
  st_as_sf()

print("a")
```


```{r}
bay_pdas <- st_read("https://opendata.arcgis.com/datasets/4df9cb38d77346a289252ced4ffa0ca0_0.geojson")

scc_pdas <-
  bay_pdas %>% 
  filter(county == "Santa Clara") %>% 
  st_transform(4269)

scc_pdas_blocks <- smc_blocks_2020[scc_pdas, ]

scc_pdas_blocks_area <-
  scc_pdas_blocks %>% 
  st_transform(26910) %>% 
  mutate(area = st_area(.))

scc_pdas_blocks_intersection <-
  scc_pdas_blocks_area %>% 
  st_intersection(
    scc_pdas %>% 
      st_transform(26910)
  )

scc_pdas_blocks_3 <-
  scc_pdas_blocks %>% 
  select(block = GEOID20) %>% 
  left_join(scc_pop_2020) %>% 
  st_transform(26910) %>% 
  mutate(original_area = st_area(.)) %>% 
  st_intersection(
    scc_pdas %>% 
      st_transform(26910)
  ) %>% 
  mutate(
    leftover_area = st_area(.),
    perc_area = leftover_area / original_area,
    pop = pop * perc_area
  )

print("b")

```

