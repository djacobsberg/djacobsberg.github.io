---
title: "Final"
author: "Daphne Jacobsberg & Catherine Beck"
date: "11/5/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

Food insecurity is one of the most significant environmental justice challenges in the United States, with more than 42 million people. Approximately 10.5% of US households experience some form of food insecurity. Hunger in America has been exacerbated by the COVID-19 pandemic, impacting families already facing hunger the most. Before the pandemic, more than 12 million children lived in food-insecure households, with that number now increasing to 13 million. BIPOC communities face the highest rates of starvation and hunger in the nation. 11.5% of people identify as food insecure within the Bay Area, with only 38% of them qualifying for food stamps. There are many ways to quantify food insecurity but access to healthy foods has been recognized as of greatest importance.

In determining the areas vulnerable to low access to healthy foods, three measures were used to create an index: household income, Hispanic/Latino ethnicity, and eligibility for SNAP. The USDA has developed a food access database that presents data by census tract for measures of supermarket accessibility. We aim to compare Alameda County, one of the areas facing greatest food insecurity in the Bay, with San Francisco County. Both are equally urban and densely populated areas but have drastically different food health and food access issues.

Is there a statistical correlation between race, SNAP eligibility, and food access? What is the relationship between race and SNAP eligibility? What is the relationship between food access and income? What is the relationship between cardiovascular health and income level? Through those questions, we will draw conclusions between race, SNAP, health metrics, and income. We chose SNAP because it sits at the intersection of food and income in a single variable. Also, we acknowledge that this is not an exclusively urban problem (there is much evidence of food insecurity in rural areas), however, the urban setting exacerbates a lot of the issues detailed above.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

```{r}
library(tidyverse)
library(sf)
library(tigris)
library(censusapi)
library(mapview)
library(devtools)
library(leaflet)
library(plotly)
library(readxl)

Sys.setenv(CENSUS_KEY="c8aa67e4086b4b5ce3a8717f59faa9a28f611dab")
```

```{r}
acs_vars_2019_5yr <-
  listCensusMetadata(
    name = "2019/acs/acs5",
    type = "variables"
  )
```

<br>
<br>

SNAP Eligibility per County in the Bay Area
(grouped by county eligibility)

```{r}
#accessed census data and filtered to achieve table with qualify and does not qualify household estimates for each county in the bay area

acs_2019_5yr_all_counties <-
  1:7 %>% 
  map_dfr(function(x){
  getCensus(
    name = "acs/acs5",
    vintage = 2019,
    region = "county:001,013,041,055,075,081,085,095,097",
    regionin = "state:06",
    vars = paste0("group(B22005",LETTERS[x],")")
  ) %>%
  select(!c(GEO_ID,state,NAME) & !ends_with(c("EA","MA","M"))) %>%
  pivot_longer(
    ends_with("E"),
    names_to = "name",
    values_to = "estimate"
  ) %>%
  left_join(
    acs_vars_2019_5yr %>% 
      select(name, label)
  )  %>%
  select(-name) %>%
  separate(
    label,
    into = c(NA,NA,"stamp"),
    sep = "!!"
  )  %>%
  filter(!is.na(stamp)) %>%
  mutate(
    stamp = case_when(
      stamp %in% c("Household received Food Stamps/SNAP in the past 12 months") ~ "Qualify",
      stamp %in% c("Household did not receive Food Stamps/SNAP in the past 12 months") ~ "Does Not Qualify"
          )
      ) %>%
  mutate(
    county = case_when(
      county == "001" ~ "Alameda",
      county == "013" ~ "Contra Costa",
      county == "041" ~ "Marin",
      county == "055" ~ "Napa",
      county == "075" ~ "San Francisco",
      county == "081" ~ "San Mateo",
      county == "085" ~ "Santa Clara",
      county == "095" ~ "Solano",
      county == "097" ~ "Sonoma"
          )
      )
  }) %>%
  group_by(county, stamp) %>%
  summarise_all(sum)
```

```{r}
#just for reference
race_categories <- c(
  "White alone",
  "Black or African American alone",
  "American Indian and Alaska Native alone",
  "Asian alone",
  "Native Hawaiian and Other Pacific Islander alone",
  "Some Other Race alone",
  "Two or more Races"
)
```

```{r}
# We tried the original ggplot method but chose to move on with the native plotly instead (see below).

# snap_by_county <-
#   acs_2019_5yr_all_counties %>% 
#   #filter(CUSTOMERCLASS %in% c("Elec- Residential", "Gas- Residential")) %>% 
#   ggplot() +
#   geom_bar(
#     aes(
#       x = county,
#       y = estimate,
#       fill = stamp
#     ),
#     stat = "identity",
#     position = "stack"
#   ) +
#   theme(axis.text.x = element_text(angle = 45)) +
#   labs(
#     x = "Counties",
#     y = "Number of Households",
#     title = "Household Eligibility for SNAP by County",
#     fill = "Eligbility"
#   )

#snap_by_county %>% ggplotly()
```

```{r}
#creates a plotly bar chart (Plots: Chapter 1.8) showing the distributions of the above mentioned table in a visual form

plot_ly() %>% 
  add_trace(
    data = acs_2019_5yr_all_counties %>% filter(stamp == "Qualify"),
    x = ~county,
    y = ~estimate,
    type = "bar",
    name = "Qualify"
  ) %>% 
  add_trace(
    data = acs_2019_5yr_all_counties %>% filter(stamp == "Does Not Qualify"),
    x = ~county,
    y = ~estimate,
    type = "bar",
    name = "Does Not Qualify"
  ) %>% 
  layout(
    xaxis = list(
      title = "Counties",
      fixedrange = T
    ),
    yaxis = list(
      title = "Number of Household",
      fixedrange = T
    ),
    barmode = "stack",
    legend = list(title = list(text = "Eligibility"))
  ) %>% 
  config(displayModeBar = F)
```

We found that Alameda County, Santa Clara, Contra Cost, and San Francisco have the highest number of qualifying households in the Bay Area. Moving on to our equity analysis, we will choose to narrow down to just Alameda County and San Francisco county because of their shared urban density and their differing food health and food access issues which may make them the most interesting to compare. 

<br>
<br>

Equity Analysis of SNAP Eligibility by Race
```{r}
#accessed census raw data again but added race breakdown layer and selected only Alameda and San Francisco counties
acs_2019_5yr_race <-
  1:7 %>% 
  map_dfr(function(x){
  getCensus(
    name = "acs/acs5",
    vintage = 2019,
    region = "county:001,075",
    regionin = "state:06",
    vars = paste0("group(B22005",LETTERS[x],")")
  ) %>%
  select(!c(GEO_ID,state,NAME) & !ends_with(c("EA","MA","M"))) %>%
  pivot_longer(
    ends_with("E"),
    names_to = "name",
    values_to = "estimate"
  ) %>%
  left_join(
    acs_vars_2019_5yr %>% 
      select(name, label)
  )  %>%
  mutate (race = race_categories[x]) %>%
  select(-name) %>%
  separate(
    label,
    into = c(NA,NA,"stamp"),
    sep = "!!"
  )  %>%
  filter(!is.na(stamp)) %>%
  mutate(
    stamp = case_when(
      stamp %in% c("Household received Food Stamps/SNAP in the past 12 months") ~ "Qualify",
      stamp %in% c("Household did not receive Food Stamps/SNAP in the past 12 months") ~ "Does Not Qualify"
          )
      ) %>%
  mutate(
    county = case_when(
      county == "001" ~ "Alameda Qualifiers",
      county == "075" ~ "San Francisco Qualifiers"
    )
  )
  })

#combined qualify and does not qualify to generate county totals for each race
total_race <-
  acs_2019_5yr_race%>%
  select(-stamp) %>%
  group_by(county, race) %>%
  summarise(estimate = sum(estimate)) %>%
  mutate(
    stamp = "Total"
  ) %>%
  mutate(
    county = case_when(
      county == "San Francisco Qualifiers" ~ "San Francsico Total",
      county == "Alameda Qualifiers" ~ "Alameda Total"
    )
  )

#used rbind function to combine totals with qualifiers, and removed does not qualify
combined <-
  acs_2019_5yr_race %>%
  rbind(total_race) %>%
  filter(stamp != "Does Not Qualify")


```

```{r}
#used ggplot again to conduct equity analysis bar chart
#this first graph shows a stacked bar graph with qualifying households only, allowing us to see the breakdown by race
counties_stacked <-
  acs_2019_5yr_race %>% 
    ggplot() +
    geom_bar(
      aes(
        x = county,
        y = estimate,
        fill = race %>% factor(levels = rev(unique(acs_2019_5yr_race$race)))
      ),
      stat = "identity",
      position = "stack"
    ) +
    labs(
      x = "Counties",
      y = "Number of households",
      title = "SNAP Qualifying households by race",
      fill = "Race of individual"
    ) +
    coord_flip() +
    theme(
      legend.position = "bottom",
      legend.direction = "vertical"
    )  +
    guides(
      fill = guide_legend(
        reverse = T
      )
    )
counties_stacked
```


```{r}
#this second bar chart is filled and combines data for qualifiers and total within county
#this allows us to compare the distributions within each county and more easily compare race distributions
counties_filled <-
  combined %>% 
    ggplot() +
    geom_bar(
      aes(
        x = county,
        y = estimate,
        fill = race %>% factor(levels = rev(unique(acs_2019_5yr_race$race)))
      ),
      stat = "identity",
      position = "fill"
    ) +
    labs(
      x = "Counties",
      y = "% of households",
      title = "% SNAP Qualifying households and Totals by race",
      fill = "Race of individual"
    ) +
    coord_flip() +
    theme(
      legend.position = "bottom",
      legend.direction = "vertical"
    )  +
    guides(
      fill = guide_legend(
        reverse = T
      )
    )
counties_filled
```

Compared the totals, the proportion of white people qualifying for SNAP decreased in both counties, the proportion of Black or African American increased in both counties. In San Francisco, the proportion of Asian people qualifying for SNAP increased slightly, whereas in Alameda county it decreased significantly. Some other race alone, native Hawaiian, American Indian and Alaska Native alone, and two or more races increased in both counties. This is not suprising, and the breakdown follows national trends (proportion of white being greatest, then Black/African American, then Hispanic and Asian). Due to our findings, we will be using Black or African American as our focus racial group from now on (health effects only). Though our results would more likely be different if we included ethnicity, for the purpose of this analysis, we will just be concentrating on race.

<br>
<br>

Correlation between building type, SNAP allocation, income and tenure
(by PUMAs)
```{r}
#extracted relevant variables from pums data for California

# pums_2019_1yr <- getCensus(
#   name = "acs/acs1/pums",
#   vintage = 2019,
#   region = "public use microdata area:*",
#   regionin = "state:06",
#   vars = c(
#     "SERIALNO",
#     "SPORDER",
#     "PWGTP",
#     "WGTP",
#     "NP",
#     "HINCP",
#     "RWAT",
#     "FFSP",
#     "KIT",
#     "BLD",
#     "TEN"
#   )
# )
# 
# saveRDS(pums_2019_1yr, "final_pums.rds")
pums_2019_1yr <- readRDS("final_pums.rds")

```


```{r}
#cleaning the data
ca_pumas <-
  pumas("CA", cb = T, progress_bar = F)


project_county_names <-
  c("Alameda",
    "San Francisco")

bay_counties <-
  counties("CA", cb = T, progress_bar = F) %>%
  filter(NAME %in% project_county_names)

bay_pumas <-
  ca_pumas %>% 
  st_centroid() %>% 
  .[bay_counties, ] %>% 
  st_drop_geometry() %>% 
  left_join(ca_pumas %>% select(GEOID10)) %>% 
  st_as_sf()

```

```{r}
#creates allocated binary variable in which income is below 66k/yr and the household was allocated SNAP benefits
bay_pums <-
  pums_2019_1yr %>% 
  mutate(
    PUMA = str_pad(public_use_microdata_area,5,"left","0"),
    HINCP = as.numeric(HINCP)
  ) %>% 
  group_by(SERIALNO) %>%
  filter(PUMA %in% bay_pumas$PUMACE10) %>%
  mutate(
    allocated = ifelse(
      (HINCP < 66000) &
        (FFSP == 1),
      1,
      0
    )
  )

#factoring the variables that we will use in the model
bay_pums_factored <-
  bay_pums %>%
  mutate(
    building = BLD %>% 
      factor(
        levels = bay_pums$BLD %>% 
          unique() %>%
          as.numeric() %>% 
          sort()
      ),
    tenure = TEN %>%
      factor(
        levels = bay_pums$TEN %>% 
          unique() %>%
          as.numeric() %>% 
          sort()
      ),
    kitchen = KIT %>%
      factor(
        levels = bay_pums$KIT %>% 
          unique() %>%
          as.numeric() %>% 
          sort()
      ),
    puma = PUMA %>%
      factor(
        levels = bay_pums$PUMA %>% 
          unique() %>%
          sort()
      )
  )
```

```{r}
#building the logit model using the factores we have identified
logit_model <- glm(
  allocated ~ building + tenure + kitchen + puma,
  family = quasibinomial(),
  data = bay_pums_factored
)

summary(logit_model)
```

Results from logit model:
Building Type: No strong correlation between Building Type and SNAP Allocation + Income.
Tenure: Although not drastically different, renters are mroe likely to be allocated SNAP than owners.
<br>
Kitchen: Outcome 1 signifies "has a kitchen" however, the results are statistically insignificant. Clearly, this factor displays no correlation and disproves our initial hypothesis that there would be a strong correlation. Outcome 2 means "has no kitchen" and thus makes sense to result in NA as there is no data.
<br>
PUMA: While all other PUMAs seem to be fairly unbiased, PUMA 07504 in San Francisco County corresponding to The Mission, Castro, Duboce Triangle and Haight Ashbury, have a strongly negative correlation with SNAP Allocation. Thus, very few people in the area have income below 66000/year and are eligible for SNAP.

<br>
<br>

CalEnviroScreen: correlating Cardiovascular Health and Poverty in Alameda and San Francisco Counties

```{r}
#access and cleaning the data (like Assignment 5)
ces4 <- read_excel("calenviroscreen40resultsdatadictionary_F_2021.xlsx")

ces4_clean <-
  ces4 %>%
  select(!ends_with("Pctl"))

ca_tracts <- tracts("CA", cb = T, progress_bar = F)

ces4_map <- ces4_clean %>%
  filter(`California County` %in% project_county_names) %>%
  left_join(
    ca_tracts %>%
      transmute(GEOID = GEOID %>% as.numeric()),
    by = c("Census Tract" = "GEOID")
  ) %>%
  st_as_sf()
```

```{r}
#still following the steps from assignment 5, we filtered for the Cardiovascular Disease variable in ces4
ces4_bay_cardio <-
  ces4_clean %>% 
  filter(`California County` %in% project_county_names) %>% 
  select(`Census Tract`, `Cardiovascular Disease`) %>% 
  left_join(
    ca_tracts %>% 
      transmute(GEOID = as.numeric(GEOID)), 
    by = c("Census Tract" = "GEOID")
  ) %>% 
  st_as_sf()

#used leaflet to map variable in geographical form focusing on our interest location (only Alameda and San Francisco counties)

cardio_pal <- colorNumeric(
  palette = "Blues",
  domain = ces4_bay_cardio$`Cardiovascular Disease`
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = ces4_bay_cardio,
    fillColor = ~cardio_pal(`Cardiovascular Disease`),
    color = "gray",
    weight = 0.5,
    fillOpacity = 0.7,
    label = ~`Cardiovascular Disease`
  ) %>%
  addLegend(
    data = ces4_bay_cardio,
    pal = cardio_pal,
    values = ~`Cardiovascular Disease`,
    title = "Prevalence of CardioVascular Disease"
  )
```

This graph shows there is a notable difference in Cardiovascular health between San Francisco and Alameda County. Especially, the San Leandro area in Hayward with a score of 21.04.

```{r}
#still following the steps from assignment 5, we filtered for the Poverty variable in ces4
ces4_bay_poverty <-
  ces4_clean %>% 
  filter(`California County` %in% project_county_names) %>% 
  filter(!is.na(Poverty)) %>%
  select(`Census Tract`, Poverty) %>% 
  left_join(
    ca_tracts %>% 
      transmute(GEOID = as.numeric(GEOID)), 
    by = c("Census Tract" = "GEOID")
  ) %>% 
  st_as_sf()

#used leaflet to map variable in geographical form focusing on our interest location (only Alameda and San Francisco counties)

poverty_pal <- colorNumeric(
  palette = "Blues",
  domain = ces4_bay_cardio$Poverty
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = ces4_bay_poverty,
    fillColor = ~poverty_pal(Poverty),
    color = "gray",
    weight = 0.5,
    fillOpacity = 0.7,
    label = ~Poverty
  ) %>%
  addLegend(
    data = ces4_bay_poverty,
    pal = poverty_pal,
    values = ~Poverty,
    title = "Poverty Level"
  )
```

In comparison to the previous map, this map shows a much more even distributed distribution of poverty households in each county. There are equally as low or high poverty levels in both areas.

```{r}
#scatter plot to show correlation between two factors in graph
bay_cardio_poverty_tract <-
  ces4_map %>%
  filter(
    !is.na(`Cardiovascular Disease`), 
    !is.na(Poverty)
  )

ggplot(
  data = bay_cardio_poverty_tract,
    aes(
      x = Poverty,
      y = `Cardiovascular Disease`
    )) +
  geom_point() +
  labs(
    title = "Cardiovascular Disease x Poverty Scatter Plot"
  ) +
  geom_smooth(method = "lm")
```

Scatter plot does not show a clear relationship, there are several outliars and the points themselves almost appear to be random.

```{r}
#model shows correlation between two facotrs in a numerical table
model <- lm(Poverty ~ `Cardiovascular Disease`, bay_cardio_poverty_tract)

summary(model)
```

As you can see, an increase of Cardiovascular Disease in one unit is associated with an increase of Poverty in 13.4; 4.2% of the variation in Cardiovascular Disease is explained by the variation in Poverty. The p-value of 1.147e-06 is <5% making these results statistically significant.

```{r}
plot(density(residuals(model)))
```

The graph above is a representation of the distribution of residuals from our model. While the peak is fairly close to 0, it is skewed the left and not evenly distributed on both sides. Thus, we will try to create a logarithmic verison of our model to try to normalize the distribution.

```{r}
#same methods as above but applying log to cardiovascular disease
ggplot(
  data = bay_cardio_poverty_tract,
    aes(
      x = Poverty,
      y = log(`Cardiovascular Disease`)
    )) +
  geom_point() +
  labs(
    title = "Cardiovascular Disease x Poverty Scatter Plot LOG"
  ) +
  geom_smooth(method = "lm")
```

The scatter plot still does not show a clear relationship as there are several outliers. The biggest difference between this scatter plot and the previous one is that the y axis has a smaller range.

```{r}
model_log <- lm(log(`Cardiovascular Disease`) ~ Poverty, bay_cardio_poverty_tract)

summary(model_log)
```

In this case, an increase of Cardiovascular Disease in one unit is associated with an increase of Poverty in 2.19; 4.0% of the variation in Cardiovascular Disease is explained by the variation in Poverty. The p-value of 2.18e-06 is <5% making these results statistically significant.

```{r}
plot(density(residuals(model_log)))
```

While the results with log are marginally better, they are still not fully normalized but allow us to draw some conclusions with caution. It shows that the data has a relatively normal distribution and so, that there is some sort of correlation between Cardiovascular Disease and Poverty.

```{r}
#geographically mapping the residuals

data_with_residuals <-
  bay_cardio_poverty_tract %>%
  mutate(
    Residuals = residuals(model_log)
  )

residuals_pal <- colorNumeric(
  palette = "YlOrRd",
  domain = data_with_residuals$Residuals
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = data_with_residuals,
    fillColor = ~residuals_pal(Residuals),
    color = "red",
    weight = 0.3,
    fillOpacity = 0.6,
    label = ~Residuals
  ) %>%
    addLegend(
    data = data_with_residuals,
    pal = residuals_pal,
    values = ~Residuals,
    title = "Residuals"
  )
```

The lowest residuals are concentrated around the San Francisco area while the highest residuals are in Alameda County. This shows that the actual data for San Francisco is similar to the results from our model regression. On the other hand, Alameda County, and especially the shoreline communities, have really skewed data meaning our regression results were significantly different from the actual data.

<br>
<br>

Equity Analysis of Individuals within a 10-mile range of a grocery store (food desert)

<br>
<br>

The USDA defines food deserts as both low income areas and ones in which more than a third of the pop at the census tract level lives over a mile from a grocery store or supermarket (10 miles for rural areas). Below is a map of the low income and low access tracts measured at one mile (given all urban areas).
```{r}
#these were some of our first attempts at accessing the USDA data
#see chunk below for final attempt

# grocery_data <- read.csv("StateAndCountyData.csv")
# 
# grocery_data_clean <-
#   grocery_data %>%
#   filter(County %in% project_county_names) %>%
#   filter(Variable_Code %in% c("LACCESS_LOWI10", "LACCESS_LOWI15", ))
#   mutate(
#     Variable_Code = case_when(
#       Variable_Code %in% c("GROC11", "GROC16") ~ "Grocery",
#       Variable_Code %in% c("SUPERC11", "SUPERC16") ~ "Supercenter",
#       Variable_Code %in% c("CONVS11", "CONVS16") ~ "Convenience",
#       Variable_Code %in% c("SPECS11", "SPECS16") ~ "Specialized",
#       Variable_Code %in% c("SNAPS12", "SNAPS17") ~ "SNAP Authorized",
#       Variable_Code %in% c("WICS11", "WICS16") ~ "WIC Authorized",
#       Variable_Code %in% c("FFR11", "FFR16") ~ "Fastfood",
#     )
#   ) %>%
#   filter(!is.na(Variable_Code)) %>%
#   select(-State) %>%
#   group_by(County, Variable_Code) %>%
#   summarize_all(sum)

# food_atlas <- read.csv("SupplementalDataCounty.csv")
# food_vars <- read.csv("VariableList.csv")
# 
# food_atlas_clean <-
#   food_atlas %>%
#   filter(County %in% c("Alameda County", "San Francisco County"))


# data_2019_clean <-
#   data_2019 %>%
#   filter(County %in% c("Alameda County", "San Francisco County")) %>%
#   select(-c("Urban", "State", "GroupQuartersFlag", "NUMGQTRS", "PCTGQTRS", "lakids1", "lakids1share", "laseniors1", "laseniors1share", "lakids10", "lakids10share", "laseniors10", "laseniors10share", "lakids20", "lakids20share", "laseniors20", "laseniors20share")) %>%
#   select(c("CensusTract", "LILATracts_1And10"))
```

```{r}
#downloaded food atlas data, combined race categories and cleaned to achieve table with estimates for race breakdown and county breakdown (again, Alameda and San Francisco only)

data_2019 <- read_excel("FoodAccessResearchAtlasData2019.xlsx", sheet = 3)

data_2019_equity <-
  data_2019 %>%
  filter(County %in% c("Alameda County", "San Francisco County")) %>%
  select(c("County", "lawhite1", "lablack1", "laasian1", "lanhopi1", "laaian1", "laomultir1")) %>%
  filter(lawhite1 != "NULL") %>%
  pivot_longer(
    starts_with("la"),
    names_to = "race",
    values_to = "estimate"
  ) %>%
  mutate(
    race = case_when(
      race == "lawhite1" ~ race_categories[1],
      race == "lablack1" ~ race_categories[2],
      race == "laasian1" ~ race_categories[4],
      race == "lanhopi1" ~ race_categories[5],
      race == "laaian1" ~ race_categories[3],
      race == "laomultir1" ~ race_categories[7],
    )
  )
  
equity_clean <-
  data_2019_equity %>%
  mutate(
    estimate = as.numeric(estimate),
    estimate = round(estimate)
  ) %>%
  group_by(race, County) %>%
  summarise(estimate = sum(estimate))
  
```

```{r}
race_stacked <-
  equity_clean %>% 
    ggplot() +
    geom_bar(
      aes(
        x = County,
        y = estimate,
        fill = race %>% factor(levels = rev(unique(equity_clean$race)))
      ),
      stat = "identity",
      position = "stack"
    ) +
    labs(
      x = "Counties",
      y = "Number of individuals",
      title = "Individuals within 10 mile range of x by race",
      fill = "Race of individual"
    ) +
    coord_flip() +
    theme(
      legend.position = "bottom",
      legend.direction = "vertical"
    )  +
    guides(
      fill = guide_legend(
        reverse = T
      )
    )

race_stacked
```

Clearly, Alameda has a drastically larger overall population, making this graph limited. Thus, we have decided to plot a second graph showing % instead.

```{r}
race_filled <-
  equity_clean %>% 
    ggplot() +
    geom_bar(
      aes(
        x = County,
        y = estimate,
        fill = race %>% factor(levels = rev(unique(equity_clean$race)))
      ),
      stat = "identity",
      position = "fill"
    ) +
    labs(
      x = "Counties",
      y = "% of individuals",
      title = "% of Individuals within 10 mile range of x by race",
      fill = "Race of individual"
    ) +
    coord_flip() +
    theme(
      legend.position = "bottom",
      legend.direction = "vertical"
    )  +
    guides(
      fill = guide_legend(
        reverse = T
      )
    )
race_filled
```

This graph however, is very informative and shows that within both San Francisco and Alameda County the race group facing the least food access issues are white people. Next however, in San Francisco is the Black or African American community while in Alameda it is the Asian community. In third, those communities are flipped for the two counties and the only other significant race category is Two or more Races.

```{r}
# bay_food_map <- data_2019_clean %>% 
#   st_as_sf(wkt= "LILATracts_1And10", crs = 4326)
# mapview(bay_food_map)
# buffer <- bay_food_map %>% 
#   st_transform(26910) %>% 
#   st_buffer(800) %>% 
#   st_transform(4269)
# mapview(buffer)
# 
# sf_cbgs <- block_groups("CA", "San Francisco")
# mapview(sf_cbgs) + mapview(buffer)
# 
# 
# sf_cbgs_within_halfmile <- sf_cbgs %>% 
#   st_centroid() %>% 
#   .[buffer, ]
# 
# mapview(sf_cbgs_within_halfmile)
# 
# sf_cbgs_food <- sf_cbgs %>% 
#   mutate(
#     within_halfmile_food = ifelse(
#       GEOID %in% sf_cbgs_within_halfmile$GEOID,
#       1,
#       0
#     )
#   )
# mapview(sf_cbgs_food, zcol = "within_halfmile_food")
```

Reflection

In further work, perhaps next quarter, it would be very interesting to plot the individual grocery stores on a map and layer our equity analysis on top of that to see a really clear relationship between race and food access. Our hypothesis that there was a relationship between food access and race was mostly supported by our analyses, so it would be great to further this exploration with more tools next quarter.  

This project gave us the opportunity to delve deeper into a serious issue within the Bay Area using our fall quarter tool kit. Though much of our analysis was pretty surface level, we were still able to create meaningful results with statistical significance.  
